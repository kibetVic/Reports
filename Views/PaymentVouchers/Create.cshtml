@model Reports.Models.PaymentVoucher

@{
    ViewData["Title"] = "Create Payment Voucher";
}

<div class="container mt-4">
    <div class="card shadow-lg rounded-3">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">Payment Voucher</h3>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post">
                <!-- Voucher Info -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label asp-for="VoucheName" class="form-label fw-bold">Voucher Number</label>
                        <input asp-for="VoucheName" class="form-control" placeholder="Voucher Name as: 2025/9/25" />
                    </div>

                    <div class="col-md-4">
                        <label asp-for="PaymentMode" class="form-label fw-bold">Payment Mode</label>
                        <select asp-for="PaymentMode" class="form-select">
                            <option value="M-pesa">M-pesa</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="PaymentInFavourOf" class="form-label fw-bold">Payment In Favour Of</label>
                        <input asp-for="PaymentInFavourOf" class="form-control" placeholder="Farmerchat activities in Nandi ..." />
                    </div>
                </div>

                <!-- Voucher Items -->
                <h4 class="mt-4">Voucher Items</h4>

                <!-- Input row for new item -->
                <div class="row mb-3 border p-3 rounded bg-light">
                    <div class="col-md-2">
                        <label class="form-label">Item Number</label>
                        <input id="newItemNo" class="form-control" type="number" placeholder="1, 2, 3,..."/>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Each Amount</label>
                        <input id="newEachAmount" class="form-control" type="number" step="0.01" placeholder=" 500, 3000,..." />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">M-Pesa Charges</label>
                        <input id="newMpesaCharges" class="form-control" type="number" step="0.01" placeholder=" 5, 9, 13, ..."/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Description</label>
                        <select id="newDescriptionSelect" class="form-select" onchange="toggleCustomDescription()">
                            <option value="">-- Select Description --</option>
                            @foreach (var desc in ViewBag.VoucherDescriptions as List<string>)
                            {
                                <option value="@desc">@desc</option>
                            }
                            <option value="__custom__" class="custom-option">➕ Others (Add New Description)</option>
                        </select>
                        <input id="newDescription" class="form-control mt-2 d-none" placeholder="Enter custom description..." />
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Cts</label>
                        <input id="newCts" class="form-control" type="number" step="1" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" onclick="addItem()">+ Add Item</button>
                    </div>
                </div>

                <!-- Table for displaying added items -->
                <table class="table table-bordered table-striped align-middle mt-3" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Item Number</th>
                            <th>Each Amount</th>
                            <th>M-Pesa Charges</th>
                            <th>Description</th>
                            <th>Cts</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- Prepared By / Checked By / Approved By -->
                <div class="row mb-3 mt-4">
                    <div class="col-md-4">
                        <label asp-for="PreparedBy" class="form-label fw-bold">Prepared By</label>
                        <input asp-for="PreparedBy" class="form-control" placeholder="Victor kibet" />
                    </div>
                    <div class="col-md-4">
                        <label asp-for="CheckedBy" class="form-label fw-bold">Checked By</label>
                        <input asp-for="CheckedBy" class="form-control" placeholder="John Emali" />
                    </div>
                    <div class="col-md-4">
                        <label asp-for="ApprovedBy" class="form-label fw-bold">Approved By</label>
                        <input asp-for="ApprovedBy" class="form-control" placeholder="Pius Sigei" />
                    </div>
                </div>

                <!-- Buttons -->
                <div class="text-end">
                    <button type="submit" class="btn btn-primary px-4">Save Voucher</button>
                    <a asp-action="Index" class="btn btn-secondary px-4">⬅ Back</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let itemIndex = 0;

        function toggleCustomDescription() {
            const select = document.getElementById("newDescriptionSelect");
            const input = document.getElementById("newDescription");

            if (select.value === "__custom__") {
                input.classList.remove("d-none");
                input.value = "";
            } else {
                input.classList.add("d-none");
                input.value = select.value;
            }
        }

        function addItem() {
            const itemNo = document.getElementById("newItemNo").value;
            const eachAmount = document.getElementById("newEachAmount").value;
            const mpesaCharges = document.getElementById("newMpesaCharges").value;
            const descriptionSelect = document.getElementById("newDescriptionSelect");
            const descriptionInput = document.getElementById("newDescription");
            const description = descriptionSelect.value === "__custom__" ? descriptionInput.value : descriptionSelect.value;
            const cts = document.getElementById("newCts").value;

            if (!itemNo || !eachAmount || !description) {
                alert("Please fill Item Number, Amount and Description.");
                return;
            }

            const tbody = document.querySelector("#itemsTable tbody");
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>
                    <input name="Items[${itemIndex}].ItemNo" class="form-control" type="number" value="${itemNo}" readonly />
                </td>
                <td>
                    <input name="Items[${itemIndex}].EachAmount" class="form-control" type="number" step="0.01" value="${eachAmount}" readonly />
                </td>
                <td>
                    <input name="Items[${itemIndex}].MpesaCharges" class="form-control" type="number" step="0.01" value="${mpesaCharges}" readonly />
                </td>
                <td>
                    <textarea name="Items[${itemIndex}].Description" class="form-control" rows="1" readonly>${description}</textarea>
                    <input type="hidden" name="itemDescriptions" value="${description}" />
                </td>
                <td>
                    <input name="Items[${itemIndex}].Cts" class="form-control" type="number" step="1" value="${cts}" readonly />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">Remove</button>
                </td>
            `;

            tbody.appendChild(row);
            itemIndex++;

            // clear inputs
            document.getElementById("newItemNo").value = "";
            document.getElementById("newEachAmount").value = "";
            document.getElementById("newMpesaCharges").value = "";
            document.getElementById("newDescriptionSelect").value = "";
            document.getElementById("newDescription").value = "";
            document.getElementById("newDescription").classList.add("d-none");
            document.getElementById("newCts").value = "";
        }

        function removeItem(button) {
            button.closest("tr").remove();
            reindexItems();
        }

        function reindexItems() {
            const rows = document.querySelectorAll("#itemsTable tbody tr");
            rows.forEach((row, index) => {
                row.querySelectorAll("input, textarea").forEach(input => {
                    input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                });
            });
            itemIndex = rows.length;
        }
    </script>
}
